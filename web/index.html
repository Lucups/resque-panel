<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ResquePanel</title>
    <link rel="stylesheet" href="/libs/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/libs/loader.min.css" type="text/css">
    <link rel="stylesheet" href="/assets/css/dashboard.css">
    <style>
        .line-scale > div {
            /*background: #39A69A;*/
            background: #3A7BBA;
        }

        #logger {
            padding: 5px;
            width: 100%;
            height: 200px;
            color: whitesmoke;
            background: black;
            overflow-y: scroll;
            font-size: 10px;
        }

        .line {
            color: yellowgreen;
            display: inline-block;
            width: 32px;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false"
                aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="#">ResquePanel</a>
    </div>
    <div id="navbar" class="collapse navbar-collapse pull-right">
        <ul class="nav navbar-nav">
            <li><a href="javascript:void(0)" class="" id="btn-config">Configuration</a></li>
            <!--<li class="active"><a href="javascript:void(0)" class="btn-lang" data-lang="en">English</a></li>-->
            <!--<li><a href="javascript:void(0)" class="btn-lang" data-lang="cn">Simple Chinese</a></li>-->
        </ul>
    </div>
</nav>

<div class="container">
    <div class="row">

        <div class="col-md-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Pending Jobs</h3>
                </div>
                <div class="panel-body">
                    <div id="queues-status" style="width: 100%; height: 200px"></div>
                </div>
            </div>
        </div>

        <!--<div class="col-md-6">-->
        <!--<div class="panel panel-default">-->
        <!--<div class="panel-heading">-->
        <!--<h3 class="panel-title">队列历史数据</h3>-->
        <!--</div>-->
        <!--<div class="panel-body">-->
        <!--<table class="table table-bordered">-->
        <!--<tr>-->
        <!--<td>A</td>-->
        <!--</tr>-->
        <!--<tr>-->
        <!--<td>A</td>-->
        <!--</tr>-->
        <!--<tr>-->
        <!--<td>A</td>-->
        <!--</tr>-->
        <!--<tr>-->
        <!--<td>A</td>-->
        <!--</tr>-->
        <!--</table>-->
        <!--</div>-->
        <!--</div>-->
        <!--</div>-->

        <!--<div class="col-md-6">-->
        <!--<div class="panel panel-default">-->
        <!--<div class="panel-heading">-->
        <!--<h3 class="panel-title">失败的 Job</h3>-->
        <!--</div>-->
        <!--<div class="panel-body">-->
        <!--<table class="table table-bordered">-->
        <!--<tr>-->
        <!--<td>A</td>-->
        <!--</tr>-->
        <!--<tr>-->
        <!--<td>A</td>-->
        <!--</tr>-->
        <!--<tr>-->
        <!--<td>A</td>-->
        <!--</tr>-->
        <!--<tr>-->
        <!--<td>A</td>-->
        <!--</tr>-->
        <!--</table>-->
        <!--</div>-->
        <!--</div>-->
        <!--</div>-->

        <div class="col-md-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Log</h3>
                </div>
                <div class="panel-body">
                    <div id="logger"></div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>
            Powered by <a href="http://tony.engineer" target="_blank">Lucups</a>,
            fork me on <a href="https://github.com/Lucups/resque-panel" target="_blank">Github</a>.
        </p>
    </footer>
</div>

<div id="modal-about" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">About</h4>
            </div>
            <div class="modal-body">
                <p>Author: Tony Lu</p>
                <p>Email: <a href="mailto:dev@tony.engineer">dev@tony.engineer</a></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">Done</button>
            </div>
        </div>
    </div>
</div>

<div id="modal-config" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Configuration</h4>
            </div>
            <div class="modal-body">
                <p>Redis Config</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary">Done</button>
            </div>
        </div>
    </div>
</div>

<script id="tpl-resque" type="text/template">
    <div class="row">
        <div class="col-lg-3 col-md-3 col-sm-12 col-xs-12">
            <div id="chart-status"></div>
        </div>
        <div class="col-lg-3 col-md-3 col-sm-12 col-xs-12">
            <div id="chart-statics"></div>
        </div>
    </div>
</script>

<script id="tpl-table" type="text/template">
    <h4>Failed Job List</h4>
    <table class="table table-bordered table-hover">
        <thead>
        <tr>
            <th>failed_at/queue/worker</th>
            <th>exception</th>
            <th>error</th>
        </tr>
        </thead>
        <tbody id="failed-jobs-table-list">
        {@each failed_jobs as job}
        <tr>
            <td>${job.failed_at}/${job.queue}/${job.worker}</td>
            <td>${job.exception}</td>
            <td>${job.error}</td>
        </tr>
        {@/each}
        </tbody>
    </table>
    <button class="btn btn-success btn-md" id="btn-loadmore">加载更多</button>
</script>

<script src="/libs/jquery/jquery-1.11.3.min.js"></script>
<script src="/libs/bootstrap/js/bootstrap.min.js"></script>
<script src="/libs/loader.js" type="text/javascript"></script>
<script src="/libs/juicer-min.js" type="text/javascript"></script>
<script src="/libs/echarts.min.js"></script>

<script>
    var storage = window.localStorage;
    var schools = [];
    var line_index = 1;
    var logger = $('#logger');

    // 基于准备好的dom，初始化echarts实例
    var queues_status = echarts.init(document.getElementById('queues-status'));
    var date = [Date.parse(new Date())];
    var data = [0];

    queues_status.setOption({
        xAxis: {
            type: 'category',
            boundaryGap: false,
            data: date
        },
        yAxis: {
            boundaryGap: [0, '50%'],
            type: 'value'
        },
        series: [
            {
                name: '成交',
                type: 'line',
                smooth: true,
                symbol: 'none',
                stack: 'a',
                areaStyle: {
                    normal: {}
                },
                data: data
            }
        ]
    });

    function update_data(resp_data, limit) {
        date.push(resp_data.time);
        data.push(resp_data.val);
        if (limit && date.length > limit) {
            date.shift();
            data.shift();
        }
    }

    function log(text) {
        logger.append('<span class="line">' + line_index + '</span> ' + text + '<br>');
        logger.scrollTop(logger[0].scrollHeight);
        line_index++;
    }

    var socket = new WebSocket('ws://192.168.33.10:11011');
    socket.onopen = function (event) {
        // server_status('已连接');
        log('Connected.');
        socket.send(JSON.stringify({
            mtd: 'status'
        }));

        socket.onmessage = function (event) {
            log('Client received a message');
            console.info(event);
            var resp = JSON.parse(event.data);
            if (resp.action) {
                switch (resp.action) {
                    case 'queues_status':
                        console.info(resp.data);
                        update_data(resp.data, 20);
                        queues_status.setOption({
                            xAxis: {
                                data: date
                            },
                            series: [{
                                name: '成交',
                                data: data
                            }]
                        });
                        break;
                    case 'output':
                        break;
                }
            }
        };

        socket.onabort = function (event) {
            log('连接已中断');
        };

        socket.onclose = function (event) {
            log('Connection is closed!');
        };
        //socket.close()
    };


    $('#btn-config').click(function () {
        $('#modal-config').modal('show');
    });

    $('#btn-about').click(function () {
        $('#modal-about').modal('show');
    });

    window.onbeforeunload = function (e) {
        console.info(e);
        // return 'Warning!';
    }
</script>
</body>
</html>